<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    #chat-container {
      flex: 1;
      width: 80%;
      max-height: 70%;
      padding: -15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f8f8f8;
      overflow: auto;
    }

    #message-input-container {
      width: 80%;
      display: flex;
      padding: 10px;
      background-color: #fff;
      border-top: 1px solid #ccc;
    }

    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #send-button {
      margin-left: 10px;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h1>Welcome to the Chat Room</h1>
  <div id="main-container"><div id="chat-container">
    <ul id="message-list"></ul>
  </div>
  <div id="user-list-container">
    <!-- Your user list content here -->
  </div>
</div>
  <div id="message-input-container">
    <input type="text" id="message-input" placeholder="Type your message..." />
    <button type="button" id="send-button">Send</button>
  </div>

  <script>
    // Connect to the Socket.io server
    const socket = io("ws://localhost:5000", {
      transports: ['websocket'],
    //   query: {
    // token: `${getCookie('token')}`,
  // },
  // Include the token in the headers
  transportOptions: {
    polling: {
      extraHeaders: {
        'authorization': `Bearer ${getCookie('token')}`, // Replace 'getCookie' with your actual cookie retrieval function
      },
    },
  },
}); // Update the server URL to match your configuration
  
console.log(getCookie('token'));

    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    const messageList = document.getElementById('message-list');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
  
    socket.emit('userConnected', {  username: username });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  
    sendButton.addEventListener('click', sendMessage);
  
    function sendMessage() {
      const message = messageInput.value;
      if (message.trim() !== '') {
        // const listItem = document.createElement('li');
        // listItem.textContent = `${username}: ${message}`;
        // messageList.appendChild(listItem);
        // messageInput.value = '';
  
        // Emit the message to the server using Socket.io

        // socket.emit('message', `${username}: ${message}`); //{  sender : username, receiver:'obaid2',text:message });
        
        // Scroll to the latest message
    //     messageList.scrollTop = messageList.scrollHeight;
    
    fetch('http://localhost:5000/messege', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ senderId:2, receiverId:3, text:message }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.info === 'Message sent successfully') {
          socket.emit('message', `${username}: ${message}`);
        }
      })
      .catch((error) => {
        console.error('An error occurred:', error);
      });



      }
    }
  
    // Listen for messages from the server
    socket.on('message', (message) => {
      // Add the received message to the chat window

   // Display the message in the chat window
   const listItem = document.createElement('li');
          listItem.textContent = message;
          messageList.appendChild(listItem);

          // Clear the message input
          messageInput.value = '';

      
      // Scroll to the latest message
      messageList.scrollTop = messageList.scrollHeight;
    });

    function getCookie(name) {
  // Split all cookies into an array of key-value pairs
  const cookies = document.cookie.split(';');

  // Iterate through cookies to find the one with the specified name
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i].trim();

    // Check if the cookie name matches the requested name
    if (cookie.startsWith(name + '=')) {
      // Return the cookie's value (decode it to handle special characters)
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }

  // Return null if the cookie with the specified name is not found
  return null;
}


  </script>
  
</body>
</html>
