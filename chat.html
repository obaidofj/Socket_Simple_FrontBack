<!DOCTYPE html>
<html>
    <head>
        <title>Chat Room</title>
        <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
      }

      #main-chat-container {
        display: flex;
        min-height: 80%;
        justify-content: center;
        width: 95%; /* Adjusted to 80% */
      }

      #separator-div {
        width: 10px;
      }

      #v-separator-div {
        height: 4px;
      }

      #chat-container {
        width: 54%; /* Adjusted to 60% */
        min-width: 400px; /* Minimum width set to 400px */
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f8f8f8;
        overflow: auto;
      }

      #user-list-container {
        width: 12%; /* Adjusted to 20% */
        min-width: 100px; /* Minimum width set to 200px */
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #d1e9f0;
        overflow: auto; /* To enable scrolling if the user list is long */
      }

      #message-input-container {
        width: 70%; /* Adjusted to 70% */
        min-width: 400px; /* Minimum width set to 400px */
        display: flex;
        padding: 10px;
        background-color: #fff;
        /* border-top: 1px solid #ccc; */
        align-items: flex-start; /* To vertically center contents */
      }

      #message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        height: 30px;
      }

      #send-button {
        margin-left: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 70px;
      }

      #attach-button {
        padding: 10px 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 30px;
      }

      #input-aside {
        width: 19.5%; /* Adjusted to 20% */
        min-width: 190px; /* Minimum width set to 200px */
        padding: 15px;
      }

      .dots-button {
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 40px; /* Adjust the width as needed */
      }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    </head>
    <body>
        <h1>Welcome to the Chat ...</h1>
        <div id="main-chat-container">
            <div id="user-list-container">
                <!-- Your user list content here --></div>
            <div id="separator-div"></div>
            <div id="chat-container">
                <ul id="message-list"></ul>
            </div>
        </div>
        <div id="v-separator-div"></div>
        <div id="message-input-container">
            <div id="input-aside"></div>
            <textarea id="message-input" placeholder="Type your message..."></textarea>
            &nbsp;&nbsp;
            <button type="button" id="attach-button" class="dots-button">...</button>
            <button type="button" id="send-button">Send</button>
        </div>
        <input
            type="file"
            id="fileInput"
            multiple
            style="display: none"
        >
        <script>
      // Connect to the Socket.io server
      const socket = io("ws://localhost:5000", {
        transports: ["websocket"],
        //   query: {
        // token: `${getCookie('token')}`,
        // },
        // Include the token in the headers
        transportOptions: {
          polling: {
            extraHeaders: {
              authorization: `Bearer ${getCookie("token")}` // Replace 'getCookie' with your actual cookie retrieval function
            }
          }
        }
      }); // Update the server URL to match your configuration

      // console.log(getCookie("token"));

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get("username");
      const messageList = document.getElementById("message-list");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const attachButton = document.getElementById("attach-button");
      

      socket.emit("userConnected", { username: username });

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // Add an event listener to handle the button click and trigger file selection
      attachButton.addEventListener("click", () => {
        fileInput.click();
      });
      
      //add event to listen when the files selected form browseing
      fileInput.addEventListener("change", () => { 
        sendMessage();
      });
      
      //add event to listen to click on sendmessege button click
      sendButton.addEventListener("click", sendMessage);

      function sendMessage() {
        const selectedFiles = fileInput.files||[];
        const message = messageInput.value;
         // Create a FormData object and append the selected files to it
        const formData = new FormData();

        for (let i = 0; i < selectedFiles.length; i++) {
          formData.append("files", selectedFiles[i]);
        }

        if (message.trim() !== "" || formData.has('files') ) {

          formData.append('senderId', '3');
          formData.append('receiverId','4');
          formData.append('text', message );

          // formData.forEach((value, key) => {
          //   console.log(`${key}: ${value}`);
          // });

          fetch(`${host}/messege`, {
            method: "POST",
            body: formData,
            credentials: 'include', // Include cookies in the request
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.info === "Message sent successfully") {
                sourceSocket=true;
                addMessegeWithAttachment(data,true,true);
                socket.emit("message", serializedFormData);
                messageInput.value = "";
              }
            })
            .catch((error) => {
              console.error("An error occurred:", error);
            });
        }
      }

      // Listen for messages from the server
      socket.on("message", (data) => {

        if(!sourceSocket){
        addMessegeWithAttachment(data);
        // Add the received message to the chat window        
      }
      });

     function  addMessegeWithAttachment(data,Source=false,Sent=true){

      // Display the message and attachments in the chat window

      if(Source==true)
      {
      if (data.message.attachmentsUrls) {
                  data.message.attachmentsUrls.forEach((file) => {
                    if (isImageFile(file)) {

                      showImg(`${host}/file/ + file`);
                    } else {
                      // Display file names for non-images
                      const fileLink = document.createElement("a");
                      // Set the link text (inner text)
                      fileLink.innerText = "Download File"; // Change the text as needed

                      // Set the href attribute (URL or file path)
                    fileLink.href = "https://example.com/path-to-your-file"; // Change the URL or file path

// Set the target attribute to open the link in a new tab (optional)
fileLink.target = "_blank";

// Append the link to the document, e.g., to a specific element with an ID
const container = document.getElementById("container"); // Change "container" to your desired ID
container.appendChild(fileLink);
                      fileName.textContent = file.name;
                      // fileList.appendChild(fileName);

                      const listItem = document.createElement("li");
                      listItem.textContent = file.name;
                      messageList.appendChild(listItem);

                      // Clear the message input
                      
                    }
                  }
                }
              }
       const listItem = document.createElement("li");
        listItem.textContent = data.text;
        messageList.appendChild(listItem);

        // Clear the message input
        messageInput.value = "";
      
        // Scroll to the latest message
        messageList.scrollTop = messageList.scrollHeight;
     }

      function getCookie(name) {
        // Split all cookies into an array of key-value pairs
        const cookies = document.cookie.split(";");

        // Iterate through cookies to find the one with the specified name
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();

          // Check if the cookie name matches the requested name
          if (cookie.startsWith(name + "=")) {
            // Return the cookie's value (decode it to handle special characters)
            return decodeURIComponent(cookie.substring(name.length + 1));
          }
        }

        // Return null if the cookie with the specified name is not found
        return null;
      }

      function isImageFile(fileName) {
        // List of common image file extensions
        const imageExtensions = [
          ".jpg",
          ".jpeg",
          ".png",
          ".gif",
          ".bmp",
          ".svg"
        ];

        // Get the file extension from the file name
        const fileExtension = fileName
          .toLowerCase()
          .slice(((fileName.lastIndexOf(".") - 1) >>> 0) + 2);

        // Check if the file extension is in the list of image extensions
        return imageExtensions.includes("." + fileExtension);
      }
    
function showImg(imageUrl) {
  fetch(imageUrl)
        .then(response => response.blob()) // Get the image data as a blob
        .then(blob => {
            // Create an img element to display the image
            const image = document.createElement('img');
            image.src = URL.createObjectURL(blob);
            image.alt = 'Image';
            
            // Append the image to the container
            // imageContainer.appendChild(image);

            const img = document.createElement("img");
                      img.src = imageUrl;
                      img.alt = "Image";
                      // fileList.appendChild(img);

                      const listItem = document.createElement("li");
                      listItem.appendChild(img);
                      messageList.appendChild(listItem);
        })
        .catch(error => {
            console.error(error);
            // Handle errors here
        });
}
        </script>
    </body>
</html>
